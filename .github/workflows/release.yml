name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version_id:
        description: "Package Version ID to promote (04t...)"
        required: true

permissions:
  contents: write

jobs:
  promote-package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Authenticate DevHub
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth.txt
          sf org login sfdx-url --sfdx-url-file auth.txt --set-default-dev-hub --alias devhub
          rm auth.txt

      - name: Get Package Version to Promote
        id: get_version
        run: |
          if [ -n "${{ github.event.inputs.version_id }}" ]; then
            # Manual trigger with specific version
            VERSION_ID="${{ github.event.inputs.version_id }}"
            echo "Using manually specified version: $VERSION_ID"
            
            VERSION_NUMBER=$(sf package version list \
              --packages DuplicateManager \
              --json | jq -r --arg id "$VERSION_ID" '.result[] | select(.SubscriberPackageVersionId == $id) | .Version')
          else
            # Find latest beta
            echo "Finding latest beta package version..."
            
            VERSION_INFO=$(sf package version list \
              --packages DuplicateManager \
              --json | jq -r '.result | map(select(.IsReleased == false)) | sort_by(.CreatedDate) | reverse | .[0]')
            
            VERSION_ID=$(echo $VERSION_INFO | jq -r '.SubscriberPackageVersionId')
            VERSION_NUMBER=$(echo $VERSION_INFO | jq -r '.Version')
          fi

          if [ -z "$VERSION_ID" ] || [ "$VERSION_ID" == "null" ]; then
            echo "::error::No beta package version found to promote"
            exit 1
          fi

          echo "version_id=$VERSION_ID" >> $GITHUB_OUTPUT
          echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT
          echo "::notice::Package to promote: $VERSION_ID ($VERSION_NUMBER)"

      - name: Promote Package Version
        run: |
          sf package version promote \
            --package ${{ steps.get_version.outputs.version_id }} \
            --no-prompt
          echo "::notice::Package promoted to Released status!"

      - name: Update Release Notes
        if: github.event_name == 'release'
        uses: actions/github-script@v7
        with:
          script: |
            const versionId = '${{ steps.get_version.outputs.version_id }}';
            const versionNumber = '${{ steps.get_version.outputs.version_number }}';

            const installInstructions = `\n\n---\n\n## ðŸ“¦ Salesforce Package\n\n**Version:** \`${versionNumber}\`\n**Package ID:** \`${versionId}\`\n\n### Install Command:\n\`\`\`bash\nsf package install --package ${versionId} --target-org your-org-alias --wait 10\n\`\`\`\n\n> âœ… This version has been promoted and can be installed in production orgs.`;

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: (context.payload.release.body || '') + installInstructions
            });

      - name: Summary
        run: |
          echo "## âœ… Package Promoted to Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "**Release:** ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Version:** \`${{ steps.get_version.outputs.version_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Package ID:** \`${{ steps.get_version.outputs.version_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The package can now be installed in production orgs." >> $GITHUB_STEP_SUMMARY
