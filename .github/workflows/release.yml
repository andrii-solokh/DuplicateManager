name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip Apex tests (not recommended)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: simple
          package-name: DuplicateManager

      - name: Release Info
        run: |
          echo "Release created: ${{ steps.release.outputs.release_created }}"
          echo "Tag: ${{ steps.release.outputs.tag_name }}"
          echo "Version: ${{ steps.release.outputs.version }}"

  create-package:
    runs-on: ubuntu-latest
    needs: release-please
    # Run if: source changed OR release was created OR manual trigger
    # Skip version bump commits
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    outputs:
      version_id: ${{ steps.create_version.outputs.version_id }}
      version_number: ${{ steps.create_version.outputs.version_number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if source changed
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Manual trigger - will create package"
          elif [ "${{ needs.release-please.outputs.release_created }}" == "true" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Release created - will create package"
          else
            # Check if src/ changed in this commit
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- src/ 2>/dev/null || echo "")
            if [ -n "$CHANGED" ]; then
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "Source files changed: $CHANGED"
            else
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "No source changes - skipping package creation"
            fi
          fi

      - name: Update version from Release Please
        if: steps.changes.outputs.changed == 'true' && needs.release-please.outputs.release_created == 'true'
        run: |
          VERSION="${{ needs.release-please.outputs.version }}"
          echo "Setting version to: $VERSION (from Release Please)"

          # Update sfdx-project.json with release version
          jq --arg v "${VERSION}.NEXT" '.packageDirectories[0].versionNumber = $v' sfdx-project.json > tmp.json
          mv tmp.json sfdx-project.json

          jq --arg v "ver ${VERSION}" '.packageDirectories[0].versionName = $v' sfdx-project.json > tmp.json
          mv tmp.json sfdx-project.json

          echo "Updated sfdx-project.json:"
          cat sfdx-project.json

      - name: Show current version
        if: steps.changes.outputs.changed == 'true'
        run: |
          echo "sfdx-project.json:"
          cat sfdx-project.json
          echo ""
          echo "Version: $(jq -r '.packageDirectories[0].versionNumber' sfdx-project.json)"

      - name: Install Salesforce CLI
        if: steps.changes.outputs.changed == 'true'
        run: npm install -g @salesforce/cli

      - name: Authenticate DevHub
        if: steps.changes.outputs.changed == 'true'
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth.txt
          sf org login sfdx-url --sfdx-url-file auth.txt --set-default-dev-hub --alias devhub
          rm auth.txt

      - name: Create Package Version
        id: create_version
        if: steps.changes.outputs.changed == 'true'
        run: |
          COVERAGE_FLAG="--code-coverage"
          if [ "${{ inputs.skip_tests }}" == "true" ]; then
            COVERAGE_FLAG=""
          fi

          set +e
          VERSION_OUTPUT=$(sf package version create \
            --package DuplicateManager \
            --installation-key-bypass \
            --wait 20 \
            $COVERAGE_FLAG \
            --json 2>&1)
          EXIT_CODE=$?
          set -e

          echo "SF Output: $VERSION_OUTPUT"

          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Package version creation failed with exit code $EXIT_CODE"
            echo "$VERSION_OUTPUT" | jq '.' 2>/dev/null || echo "$VERSION_OUTPUT"
            exit $EXIT_CODE
          fi

          VERSION_ID=$(echo $VERSION_OUTPUT | jq -r '.result.SubscriberPackageVersionId')
          VERSION_NUMBER=$(echo $VERSION_OUTPUT | jq -r '.result.Version')

          echo "version_id=$VERSION_ID" >> $GITHUB_OUTPUT
          echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT
          echo "::notice::Package version created: $VERSION_ID ($VERSION_NUMBER)"

      - name: Comment on Commit
        if: steps.changes.outputs.changed == 'true' && github.event_name == 'push' && needs.release-please.outputs.release_created != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `ðŸ“¦ **Beta Package Created**\n\nVersion: \`${{ steps.create_version.outputs.version_number }}\`\nPackage ID: \`${{ steps.create_version.outputs.version_id }}\`\n\n**Install in sandbox:**\n\`\`\`bash\nsf package install --package ${{ steps.create_version.outputs.version_id }} --target-org your-sandbox-alias --wait 10\n\`\`\`\n\n> âš ï¸ This is a beta version and can only be installed in sandboxes. Merge the Release PR to promote for production.`
            })

      - name: Summary
        if: steps.changes.outputs.changed == 'true'
        run: |
          if [ "${{ needs.release-please.outputs.release_created }}" == "true" ]; then
            echo "## ðŸš€ Release Package Created" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸ“¦ Beta Package Created" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.create_version.outputs.version_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Package ID:** \`${{ steps.create_version.outputs.version_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install command:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "sf package install --package ${{ steps.create_version.outputs.version_id }} --target-org your-org-alias --wait 10" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  promote-package:
    runs-on: ubuntu-latest
    needs: [release-please, create-package]
    if: needs.release-please.outputs.release_created == 'true' && needs.create-package.outputs.version_id != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Authenticate DevHub
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth.txt
          sf org login sfdx-url --sfdx-url-file auth.txt --set-default-dev-hub --alias devhub
          rm auth.txt

      - name: Promote Package Version
        run: |
          sf package version promote \
            --package ${{ needs.create-package.outputs.version_id }} \
            --no-prompt
          echo "::notice::Package promoted to Released status!"

      - name: Update Release Notes
        uses: actions/github-script@v7
        with:
          script: |
            const versionId = '${{ needs.create-package.outputs.version_id }}';
            const versionNumber = '${{ needs.create-package.outputs.version_number }}';

            // Find the release by tag
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 5
            });

            const release = releases.data.find(r => r.tag_name === '${{ needs.release-please.outputs.tag_name }}');
            if (!release) {
              console.log('Release not found');
              return;
            }

            const installInstructions = `\n\n---\n\n## ðŸ“¦ Salesforce Package\n\n**Version:** \`${versionNumber}\`\n**Package ID:** \`${versionId}\`\n\n### Install Command:\n\`\`\`bash\nsf package install --package ${versionId} --target-org your-org-alias --wait 10\n\`\`\`\n\n> âœ… This version has been promoted and can be installed in production orgs.`;

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              body: (release.body || '') + installInstructions
            });

      - name: Summary
        run: |
          echo "## âœ… Package Promoted to Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** ${{ needs.release-please.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Package ID:** \`${{ needs.create-package.outputs.version_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The package can now be installed in production orgs." >> $GITHUB_STEP_SUMMARY
