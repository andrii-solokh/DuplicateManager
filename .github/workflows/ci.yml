name: CI

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      prs_created: ${{ steps.release.outputs.prs_created }}
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Release Info
        run: |
          echo "Release created: ${{ steps.release.outputs.release_created }}"
          echo "PRs created: ${{ steps.release.outputs.prs_created }}"
          echo "Tag: ${{ steps.release.outputs.tag_name }}"
          echo "Version: ${{ steps.release.outputs.version }}"

  create-beta:
    runs-on: ubuntu-latest
    needs: release-please
    # Only run if NO release was created (we're accumulating changes, not releasing)
    if: needs.release-please.outputs.release_created != 'true'
    steps:
      - name: Check for Release PR
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find open release-please PR
          PR_INFO=$(gh pr list --repo ${{ github.repository }} --state open --json number,headRefName,title \
            --jq '.[] | select(.headRefName | startswith("release-please--branches--main"))' | head -1)

          if [ -n "$PR_INFO" ]; then
            PR_NUMBER=$(echo "$PR_INFO" | jq -r '.number')
            PR_BRANCH=$(echo "$PR_INFO" | jq -r '.headRefName')
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "pr_branch=$PR_BRANCH" >> $GITHUB_OUTPUT
            echo "::notice::Found release PR #$PR_NUMBER on branch $PR_BRANCH"
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "::notice::No open release PR found - skipping beta creation"
          fi

      - name: Checkout PR branch
        if: steps.check_pr.outputs.pr_exists == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.check_pr.outputs.pr_branch }}

      - name: Get version from PR
        if: steps.check_pr.outputs.pr_exists == 'true'
        id: version
        run: |
          VERSION=$(jq -r '."."' .release-please-manifest.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "::notice::Creating beta package for version $VERSION"

      - name: Install Salesforce CLI
        if: steps.check_pr.outputs.pr_exists == 'true'
        run: npm install -g @salesforce/cli

      - name: Authenticate DevHub
        if: steps.check_pr.outputs.pr_exists == 'true'
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth.txt
          sf org login sfdx-url --sfdx-url-file auth.txt --set-default-dev-hub --alias devhub
          rm auth.txt

      - name: Create Package Version (Beta)
        if: steps.check_pr.outputs.pr_exists == 'true'
        id: create_version
        run: |
          set +e
          VERSION_OUTPUT=$(sf package version create \
            --package DuplicateManager \
            --installation-key-bypass \
            --wait 20 \
            --code-coverage \
            --json 2>&1)
          EXIT_CODE=$?
          set -e

          echo "SF Output: $VERSION_OUTPUT"

          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Package version creation failed with exit code $EXIT_CODE"
            echo "$VERSION_OUTPUT" | jq '.' 2>/dev/null || echo "$VERSION_OUTPUT"
            exit $EXIT_CODE
          fi

          VERSION_ID=$(echo $VERSION_OUTPUT | jq -r '.result.SubscriberPackageVersionId')
          VERSION_NUMBER=$(echo $VERSION_OUTPUT | jq -r '.result.Version')

          echo "version_id=$VERSION_ID" >> $GITHUB_OUTPUT
          echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT
          echo "::notice::Beta package version created: $VERSION_ID ($VERSION_NUMBER)"

      - name: Comment on PR
        if: steps.check_pr.outputs.pr_exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const versionId = '${{ steps.create_version.outputs.version_id }}';
            const versionNumber = '${{ steps.create_version.outputs.version_number }}';
            const releaseVersion = '${{ steps.version.outputs.version }}';
            const prNumber = parseInt('${{ steps.check_pr.outputs.pr_number }}');

            const body = [
              '## ðŸ“¦ Beta Package Ready for Testing',
              '',
              `**Release Version:** \`${releaseVersion}\``,
              `**Package Version:** \`${versionNumber}\``,
              `**Package ID:** \`${versionId}\``,
              '',
              '### Install in sandbox:',
              '```bash',
              `sf package install --package ${versionId} --target-org your-sandbox-alias --wait 10`,
              '```',
              '',
              '> âš ï¸ This is a beta version for testing. Merge this PR to create the official release and promote the package for production installation.'
            ].join('\n');

            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('Beta Package Ready for Testing')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

      - name: Summary
        if: steps.check_pr.outputs.pr_exists == 'true'
        run: |
          echo "## ðŸ“¦ Beta Package Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release PR:** #${{ steps.check_pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Package Version:** \`${{ steps.create_version.outputs.version_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Package ID:** \`${{ steps.create_version.outputs.version_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install in sandbox:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "sf package install --package ${{ steps.create_version.outputs.version_id }} --target-org your-sandbox-alias --wait 10" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: No PR Summary
        if: steps.check_pr.outputs.pr_exists != 'true'
        run: |
          echo "## â„¹ï¸ No Beta Package Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No open release PR found. Beta packages are only created when a release PR exists." >> $GITHUB_STEP_SUMMARY

  promote-package:
    runs-on: ubuntu-latest
    needs: release-please
    # Only run when a release was created (release PR was merged)
    if: needs.release-please.outputs.release_created == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Authenticate DevHub
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth.txt
          sf org login sfdx-url --sfdx-url-file auth.txt --set-default-dev-hub --alias devhub
          rm auth.txt

      - name: Get Package Version to Promote
        id: get_version
        run: |
          RELEASE_TAG="${{ needs.release-please.outputs.tag_name }}"
          # Extract version: DuplicateManager-v1.2.0 -> 1.2.0 or v1.2.0 -> 1.2.0
          RELEASE_VERSION=$(echo "$RELEASE_TAG" | sed 's/.*v//')
          echo "Finding beta package for release version: $RELEASE_VERSION"

          # Find the latest beta package matching the release version (e.g., 1.2.0.X for v1.2.0)
          VERSION_INFO=$(sf package version list \
            --packages DuplicateManager \
            --json | jq -r --arg ver "$RELEASE_VERSION" \
            '.result | map(select(.IsReleased == false and (.Version | startswith($ver + ".")))) | sort_by(.CreatedDate) | reverse | .[0]')

          VERSION_ID=$(echo $VERSION_INFO | jq -r '.SubscriberPackageVersionId')
          VERSION_NUMBER=$(echo $VERSION_INFO | jq -r '.Version')

          # Fallback to any latest beta if no version-specific match
          if [ -z "$VERSION_ID" ] || [ "$VERSION_ID" == "null" ]; then
            echo "No version-specific beta found, falling back to latest beta..."
            VERSION_INFO=$(sf package version list \
              --packages DuplicateManager \
              --json | jq -r '.result | map(select(.IsReleased == false)) | sort_by(.CreatedDate) | reverse | .[0]')

            VERSION_ID=$(echo $VERSION_INFO | jq -r '.SubscriberPackageVersionId')
            VERSION_NUMBER=$(echo $VERSION_INFO | jq -r '.Version')
          fi

          if [ -z "$VERSION_ID" ] || [ "$VERSION_ID" == "null" ]; then
            echo "::error::No beta package version found to promote"
            exit 1
          fi

          echo "version_id=$VERSION_ID" >> $GITHUB_OUTPUT
          echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT
          echo "::notice::Package to promote: $VERSION_ID ($VERSION_NUMBER)"

      - name: Promote Package Version
        run: |
          sf package version promote \
            --package ${{ steps.get_version.outputs.version_id }} \
            --no-prompt
          echo "::notice::Package promoted to Released status!"

      - name: Update Release Notes
        uses: actions/github-script@v7
        with:
          script: |
            const versionId = '${{ steps.get_version.outputs.version_id }}';
            const versionNumber = '${{ steps.get_version.outputs.version_number }}';
            const tagName = '${{ needs.release-please.outputs.tag_name }}';

            // Find the release by tag
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 5
            });

            const release = releases.find(r => r.tag_name === tagName);
            if (!release) {
              console.log('Release not found for tag:', tagName);
              return;
            }

            const installInstructions = [
              '',
              '---',
              '',
              '## ðŸ“¦ Salesforce Package',
              '',
              `**Version:** \`${versionNumber}\``,
              `**Package ID:** \`${versionId}\``,
              '',
              '### Install Command:',
              '```bash',
              `sf package install --package ${versionId} --target-org your-org-alias --wait 10`,
              '```',
              '',
              '> âœ… This version has been promoted and can be installed in production orgs.'
            ].join('\n');

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              body: (release.body || '') + installInstructions
            });

      - name: Summary
        run: |
          echo "## âœ… Package Promoted to Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** ${{ needs.release-please.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.get_version.outputs.version_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Package ID:** \`${{ steps.get_version.outputs.version_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The package can now be installed in production orgs." >> $GITHUB_STEP_SUMMARY
