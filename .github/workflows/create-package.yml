name: Create Package Version

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "sfdx-project.json"
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip Apex tests (not recommended)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  create-beta:
    runs-on: ubuntu-latest
    outputs:
      version_id: ${{ steps.create_version.outputs.version_id }}
      version_number: ${{ steps.create_version.outputs.version_number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Authenticate DevHub
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth.txt
          sf org login sfdx-url --sfdx-url-file auth.txt --set-default-dev-hub --alias devhub
          rm auth.txt

      - name: Show current version
        run: |
          echo "Current sfdx-project.json:"
          cat sfdx-project.json
          echo ""
          echo "Version: $(jq -r '.packageDirectories[0].versionNumber' sfdx-project.json)"

      - name: Create Package Version (Beta)
        id: create_version
        run: |
          COVERAGE_FLAG="--code-coverage"
          if [ "${{ inputs.skip_tests }}" == "true" ]; then
            COVERAGE_FLAG=""
          fi

          set +e
          VERSION_OUTPUT=$(sf package version create \
            --package DuplicateManager \
            --installation-key-bypass \
            --wait 20 \
            $COVERAGE_FLAG \
            --json 2>&1)
          EXIT_CODE=$?
          set -e

          echo "SF Output: $VERSION_OUTPUT"

          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Package version creation failed with exit code $EXIT_CODE"
            echo "$VERSION_OUTPUT" | jq '.' 2>/dev/null || echo "$VERSION_OUTPUT"
            exit $EXIT_CODE
          fi

          VERSION_ID=$(echo $VERSION_OUTPUT | jq -r '.result.SubscriberPackageVersionId')
          VERSION_NUMBER=$(echo $VERSION_OUTPUT | jq -r '.result.Version')

          echo "version_id=$VERSION_ID" >> $GITHUB_OUTPUT
          echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT
          echo "::notice::Beta package version created: $VERSION_ID ($VERSION_NUMBER)"

      - name: Comment on Commit
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `üì¶ **Beta Package Created**\n\nVersion: \`${{ steps.create_version.outputs.version_number }}\`\nPackage ID: \`${{ steps.create_version.outputs.version_id }}\`\n\n**Install in sandbox:**\n\`\`\`bash\nsf package install --package ${{ steps.create_version.outputs.version_id }} --target-org your-sandbox-alias --wait 10\n\`\`\`\n\n> ‚ö†Ô∏è This is a beta version and can only be installed in sandboxes. Create a GitHub Release to promote for production.`
            })
