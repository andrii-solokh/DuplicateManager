name: Create Beta Package

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  create-beta:
    # Only run for release-please PRs
    if: startsWith(github.head_ref, 'release-please--branches--main')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Get version from PR
        id: version
        run: |
          VERSION=$(jq -r '."."' .release-please-manifest.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "::notice::Creating beta package for version $VERSION"

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Authenticate DevHub
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth.txt
          sf org login sfdx-url --sfdx-url-file auth.txt --set-default-dev-hub --alias devhub
          rm auth.txt

      - name: Create Package Version (Beta)
        id: create_version
        run: |
          set +e
          VERSION_OUTPUT=$(sf package version create \
            --package DuplicateManager \
            --installation-key-bypass \
            --wait 20 \
            --code-coverage \
            --json 2>&1)
          EXIT_CODE=$?
          set -e

          echo "SF Output: $VERSION_OUTPUT"

          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Package version creation failed with exit code $EXIT_CODE"
            echo "$VERSION_OUTPUT" | jq '.' 2>/dev/null || echo "$VERSION_OUTPUT"
            exit $EXIT_CODE
          fi

          VERSION_ID=$(echo $VERSION_OUTPUT | jq -r '.result.SubscriberPackageVersionId')
          VERSION_NUMBER=$(echo $VERSION_OUTPUT | jq -r '.result.Version')

          echo "version_id=$VERSION_ID" >> $GITHUB_OUTPUT
          echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT
          echo "::notice::Beta package version created: $VERSION_ID ($VERSION_NUMBER)"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const versionId = '${{ steps.create_version.outputs.version_id }}';
            const versionNumber = '${{ steps.create_version.outputs.version_number }}';
            const releaseVersion = '${{ steps.version.outputs.version }}';

            const body = `## ðŸ“¦ Beta Package Ready for Testing

            **Release Version:** \`${releaseVersion}\`
            **Package Version:** \`${versionNumber}\`
            **Package ID:** \`${versionId}\`

            ### Install in sandbox:
            \`\`\`bash
            sf package install --package ${versionId} --target-org your-sandbox-alias --wait 10
            \`\`\`

            > âš ï¸ This is a beta version for testing. Merge this PR to create the official release and promote the package for production installation.`;

            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('Beta Package Ready for Testing')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Summary
        run: |
          echo "## ðŸ“¦ Beta Package Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Package Version:** \`${{ steps.create_version.outputs.version_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Package ID:** \`${{ steps.create_version.outputs.version_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install in sandbox:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "sf package install --package ${{ steps.create_version.outputs.version_id }} --target-org your-sandbox-alias --wait 10" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
