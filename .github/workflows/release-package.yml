name: Release Package Version

on:
  # Trigger when GitHub Release is published (Release PR merged)
  release:
    types: [published]
  # Manual trigger with specific version
  workflow_dispatch:
    inputs:
      version_id:
        description: "Package Version ID to promote (04t...)"
        required: true

permissions:
  contents: write

jobs:
  promote-package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Authenticate DevHub
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth.txt
          sf org login sfdx-url --sfdx-url-file auth.txt --set-default-dev-hub --alias devhub
          rm auth.txt

      - name: Get Package Version to Promote
        id: get_version
        run: |
          # Check if manually triggered with version ID
          if [ -n "${{ github.event.inputs.version_id }}" ]; then
            VERSION_INFO="${{ github.event.inputs.version_id }}"
            echo "Using manually specified version: $VERSION_INFO"
          else
            # Get the latest beta version (most recently created)
            echo "Finding latest beta package version..."
            VERSION_INFO=$(sf package version list \
              --packages DuplicateManager \
              --json | jq -r '.result | map(select(.IsReleased == false)) | sort_by(.CreatedDate) | reverse | .[0].SubscriberPackageVersionId')
          fi

          if [ -z "$VERSION_INFO" ] || [ "$VERSION_INFO" == "null" ]; then
            echo "::error::No beta package version found to promote"
            exit 1
          fi

          echo "version_id=$VERSION_INFO" >> $GITHUB_OUTPUT
          echo "::notice::Found package version to promote: $VERSION_INFO"

      - name: Promote Package Version
        run: |
          sf package version promote \
            --package ${{ steps.get_version.outputs.version_id }} \
            --no-prompt
          echo "::notice::Package promoted to Released status!"

      - name: Update Release Notes
        if: github.event_name == 'release'
        uses: actions/github-script@v7
        with:
          script: |
            const versionId = '${{ steps.get_version.outputs.version_id }}';

            const installInstructions = `\n\n---\n\n## ðŸ“¦ Salesforce Package\n\n**Package Version ID:** \`${versionId}\`\n\n### Install Command:\n\`\`\`bash\nsf package install --package ${versionId} --target-org your-org-alias --wait 10\n\`\`\`\n\n> âœ… This version has been promoted and can be installed in production orgs.`;

            const release = await github.rest.repos.getRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id
            });

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: (release.data.body || '') + installInstructions
            });

      - name: Summary
        run: |
          echo "## âœ… Package Promoted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package ID:** \`${{ steps.get_version.outputs.version_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The package has been promoted and can now be installed in production orgs." >> $GITHUB_STEP_SUMMARY
