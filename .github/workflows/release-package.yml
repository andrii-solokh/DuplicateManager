name: Release Package Version

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version_id:
        description: 'Package Version ID to promote (04t...)'
        required: true

jobs:
  promote-package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Authenticate DevHub
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth.txt
          sf org login sfdx-url --sfdx-url-file auth.txt --set-default-dev-hub --alias devhub
          rm auth.txt

      - name: Get Package Version to Promote
        id: get_version
        run: |
          # Check if manually triggered with version ID
          if [ -n "${{ github.event.inputs.version_id }}" ]; then
            VERSION_INFO="${{ github.event.inputs.version_id }}"
            echo "Using manually specified version: $VERSION_INFO"
          else
            # Get the latest beta version (most recently created)
            VERSION_INFO=$(sf package version list \
              --packages DuplicateManager \
              --json | jq -r '.result | map(select(.IsReleased == false)) | sort_by(.CreatedDate) | reverse | .[0].SubscriberPackageVersionId')
          fi

          if [ -z "$VERSION_INFO" ] || [ "$VERSION_INFO" == "null" ]; then
            echo "::error::No package version found to promote"
            exit 1
          fi

          echo "version_id=$VERSION_INFO" >> $GITHUB_OUTPUT
          echo "::notice::Found package version to promote: $VERSION_INFO"

      - name: Promote Package Version
        run: |
          sf package version promote \
            --package ${{ steps.get_version.outputs.version_id }} \
            --no-prompt
          echo "::notice::Package promoted to Released status!"

      - name: Update Release Notes
        uses: actions/github-script@v7
        with:
          script: |
            const currentBody = context.payload.release.body || '';
            const installInstructions = `

            ---

            ## Installation

            **Production/Sandbox Install:**
            \`\`\`bash
            sf package install --package ${{ steps.get_version.outputs.version_id }} --target-org your-org-alias --wait 10
            \`\`\`

            **Package Version ID:** \`${{ steps.get_version.outputs.version_id }}\`

            > âœ… This version has been promoted and can be installed in production orgs.
            `;

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: currentBody + installInstructions
            });
