name: Release Package Version

on:
  # Trigger after Create Package Version workflow completes on a release
  workflow_run:
    workflows: ["Create Package Version"]
    types: [completed]
    branches: [main]
  # Manual trigger with specific version
  workflow_dispatch:
    inputs:
      version_id:
        description: "Package Version ID to promote (04t...)"
        required: true

permissions:
  contents: write

jobs:
  promote-package:
    runs-on: ubuntu-latest
    # Only run if: manually triggered OR (workflow_run succeeded AND there's a recent release)
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event.workflow_run.conclusion == 'success')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for recent release
        id: check_release
        if: github.event_name == 'workflow_run'
        uses: actions/github-script@v7
        with:
          script: |
            // Get releases from last hour
            const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 5
            });

            const recentRelease = releases.data.find(r => 
              new Date(r.published_at) > new Date(oneHourAgo) && !r.draft
            );

            if (recentRelease) {
              console.log(`Found recent release: ${recentRelease.tag_name}`);
              core.setOutput('has_release', 'true');
              core.setOutput('release_id', recentRelease.id);
              core.setOutput('release_tag', recentRelease.tag_name);
            } else {
              console.log('No recent release found - skipping promotion');
              core.setOutput('has_release', 'false');
            }

      - name: Skip if no release
        if: github.event_name == 'workflow_run' && steps.check_release.outputs.has_release != 'true'
        run: |
          echo "No recent release found. Beta was created but won't be promoted."
          echo "This is expected for regular commits to main."
          exit 0

      - name: Install Salesforce CLI
        if: github.event_name == 'workflow_dispatch' || steps.check_release.outputs.has_release == 'true'
        run: npm install -g @salesforce/cli

      - name: Authenticate DevHub
        if: github.event_name == 'workflow_dispatch' || steps.check_release.outputs.has_release == 'true'
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth.txt
          sf org login sfdx-url --sfdx-url-file auth.txt --set-default-dev-hub --alias devhub
          rm auth.txt

      - name: Get Package Version to Promote
        id: get_version
        if: github.event_name == 'workflow_dispatch' || steps.check_release.outputs.has_release == 'true'
        run: |
          # Check if manually triggered with version ID
          if [ -n "${{ github.event.inputs.version_id }}" ]; then
            VERSION_INFO="${{ github.event.inputs.version_id }}"
            echo "Using manually specified version: $VERSION_INFO"
          else
            # Get the latest beta version (most recently created)
            VERSION_INFO=$(sf package version list \
              --packages DuplicateManager \
              --json | jq -r '.result | map(select(.IsReleased == false)) | sort_by(.CreatedDate) | reverse | .[0].SubscriberPackageVersionId')
          fi

          if [ -z "$VERSION_INFO" ] || [ "$VERSION_INFO" == "null" ]; then
            echo "::error::No package version found to promote"
            exit 1
          fi

          echo "version_id=$VERSION_INFO" >> $GITHUB_OUTPUT
          echo "::notice::Found package version to promote: $VERSION_INFO"

      - name: Promote Package Version
        if: github.event_name == 'workflow_dispatch' || steps.check_release.outputs.has_release == 'true'
        run: |
          sf package version promote \
            --package ${{ steps.get_version.outputs.version_id }} \
            --no-prompt
          echo "::notice::Package promoted to Released status!"

      - name: Update Release Notes
        if: steps.check_release.outputs.has_release == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const releaseId = ${{ steps.check_release.outputs.release_id }};
            const release = await github.rest.repos.getRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId
            });

            const currentBody = release.data.body || '';
            const versionId = '${{ steps.get_version.outputs.version_id }}';

            const installInstructions = `\n\n---\n\n## ðŸ“¦ Salesforce Package\n\n**Package Version ID:** \`${versionId}\`\n\n### Install Command:\n\`\`\`bash\nsf package install --package ${versionId} --target-org your-org-alias --wait 10\n\`\`\`\n\n> âœ… This version has been promoted and can be installed in production orgs.`;

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId,
              body: currentBody + installInstructions
            });

      - name: Summary
        if: github.event_name == 'workflow_dispatch' || steps.check_release.outputs.has_release == 'true'
        run: |
          echo "## âœ… Package Promoted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package ID:** \`${{ steps.get_version.outputs.version_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The package has been promoted and can now be installed in production orgs." >> $GITHUB_STEP_SUMMARY
