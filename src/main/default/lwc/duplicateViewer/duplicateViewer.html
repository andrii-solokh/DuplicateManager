<template>
  <!-- Header Section -->
  <div class="container">
    <header class="header">
      <div class="header-content">
        <div class="header-title">
          <lightning-icon
            icon-name="standard:record_lookup"
            size="medium"
            class="header-icon"
          ></lightning-icon>
          <h1>Duplicate Manager</h1>
        </div>
        <p class="header-subtitle">
          View and manage duplicate records across your organization
        </p>
      </div>
    </header>

    <!-- Job Status Banner (when job is running) -->
    <template if:true={hasRunningJob}>
      <section class="job-status-banner">
        <div class="job-status-content">
          <div class="job-status-info">
            <lightning-icon
              icon-name="utility:sync"
              size="small"
              class="job-icon"
            ></lightning-icon>
            <div class="job-status-text">
              <span class="job-status-label"
                >Scanning {scanningObjectType}...</span
              >
              <span class="job-status-detail">{runningJobStatus}</span>
            </div>
          </div>
          <div class="job-progress-container">
            <lightning-progress-bar
              value={runningJobProgress}
              size="medium"
              variant="brand"
              class="job-progress"
            ></lightning-progress-bar>
            <span class="job-progress-text">{runningJobProgress}%</span>
          </div>
          <lightning-button-icon
            icon-name="utility:close"
            variant="bare-inverse"
            alternative-text="Stop scan"
            title="Stop scan"
            onclick={handleStopScan}
            class="stop-btn"
          ></lightning-button-icon>
        </div>
      </section>
    </template>

    <!-- Summary Cards -->
    <section class="summary-section">
      <div class="summary-cards">
        <div class="summary-card total-sets">
          <div class="card-icon">
            <lightning-icon
              icon-name="utility:collection_variable"
              size="small"
            ></lightning-icon>
          </div>
          <div class="card-content">
            <span class="card-value">{summary.totalSets}</span>
            <span class="card-label">Duplicate Sets</span>
          </div>
        </div>
        <div class="summary-card total-items">
          <div class="card-icon">
            <lightning-icon
              icon-name="utility:record"
              size="small"
            ></lightning-icon>
          </div>
          <div class="card-content">
            <span class="card-value">{summary.totalItems}</span>
            <span class="card-label">Total Records</span>
          </div>
        </div>
        <template for:each={summary.setsByObject} for:item="objCount">
          <div
            key={objCount.objectType}
            class="summary-card object-count clickable"
            onclick={handleSummaryCardClick}
            data-object={objCount.objectType}
          >
            <div class="card-icon">
              <lightning-icon
                icon-name="utility:sobject"
                size="small"
              ></lightning-icon>
            </div>
            <div class="card-content">
              <span class="card-value">{objCount.count}</span>
              <span class="card-label"
                >{objCount.objectType} Duplicate Sets</span
              >
            </div>
          </div>
        </template>
      </div>
    </section>

    <!-- Controls Section -->
    <section class="controls-section">
      <div class="controls-row">
        <div class="filter-group">
          <lightning-combobox
            name="objectFilter"
            label="Filter by Object"
            value={selectedObjectType}
            placeholder="Select Object Type"
            options={objectTypeOptions}
            onchange={handleObjectTypeChange}
            variant="label-hidden"
            class="filter-combo"
          >
          </lightning-combobox>
        </div>
        <div class="action-group">
          <lightning-button
            label={refreshButtonLabel}
            icon-name="utility:refresh"
            variant="neutral"
            onclick={handleRefresh}
            disabled={refreshButtonDisabled}
            class="action-btn"
          >
          </lightning-button>
          <lightning-button
            label="Run Duplicate Scan"
            icon-name="utility:scan"
            variant="brand"
            onclick={handleRunScan}
            disabled={isRunScanDisabled}
            class="action-btn"
          >
          </lightning-button>
          <lightning-button-icon
            icon-name="utility:clock"
            variant="border-filled"
            alternative-text="Schedule settings"
            onclick={handleToggleSchedulePanel}
            class="schedule-btn"
            title="Schedule daily scan"
          >
          </lightning-button-icon>
        </div>
      </div>

      <!-- Schedule Panel -->
      <template if:true={showSchedulePanel}>
        <div class="schedule-panel">
          <div class="schedule-header">
            <lightning-icon
              icon-name="utility:clock"
              size="x-small"
            ></lightning-icon>
            <span class="schedule-title">Daily Scan Schedule</span>
            <template if:true={isScheduleDisabled}>
              <span class="schedule-note">(Select an object type first)</span>
            </template>
          </div>
          <div class="schedule-content">
            <div class="schedule-status">
              <template if:true={hasActiveSchedule}>
                <div class="schedule-active">
                  <lightning-icon
                    icon-name="utility:success"
                    variant="success"
                    size="x-small"
                  ></lightning-icon>
                  <span
                    >Scheduled daily at
                    <strong>{activeScheduleTime}</strong></span
                  >
                  <template if:true={nextFireTime}>
                    <span class="next-run"
                      >Next run:
                      <lightning-formatted-date-time
                        value={nextFireTime}
                        year="numeric"
                        month="short"
                        day="2-digit"
                        hour="2-digit"
                        minute="2-digit"
                      >
                      </lightning-formatted-date-time>
                    </span>
                  </template>
                </div>
              </template>
              <template if:false={hasActiveSchedule}>
                <div class="schedule-inactive">
                  <lightning-icon
                    icon-name="utility:info"
                    size="x-small"
                  ></lightning-icon>
                  <span>No schedule configured for {selectedObjectType}</span>
                </div>
              </template>
            </div>
            <div class="schedule-controls">
              <lightning-input
                type="time"
                label="Run at"
                value={scheduleTime}
                onchange={handleScheduleTimeChange}
                disabled={isScheduleDisabled}
                class="schedule-time-input"
              >
              </lightning-input>
              <template if:true={hasActiveSchedule}>
                <lightning-button
                  label="Update Schedule"
                  variant="brand"
                  onclick={handleScheduleJob}
                  disabled={isScheduleDisabled}
                  class="schedule-action-btn"
                >
                </lightning-button>
                <lightning-button
                  label="Cancel Schedule"
                  variant="destructive-text"
                  onclick={handleUnscheduleJob}
                  disabled={isScheduleDisabled}
                  class="schedule-action-btn"
                >
                </lightning-button>
              </template>
              <template if:false={hasActiveSchedule}>
                <lightning-button
                  label="Enable Daily Scan"
                  variant="brand"
                  onclick={handleScheduleJob}
                  disabled={isScheduleDisabled}
                  class="schedule-action-btn"
                >
                </lightning-button>
              </template>
            </div>
          </div>
        </div>
      </template>
    </section>

    <!-- Error State -->
    <template if:true={error}>
      <div class="error-container">
        <lightning-icon
          icon-name="utility:error"
          variant="error"
          size="large"
        ></lightning-icon>
        <p class="error-text">{error}</p>
        <lightning-button
          label="Try Again"
          onclick={handleRefresh}
          variant="neutral"
        ></lightning-button>
      </div>
    </template>

    <!-- Empty State -->
    <template if:true={showEmptyState}>
      <div class="empty-state">
        <div class="empty-icon">
          <lightning-icon
            icon-name="utility:check"
            size="large"
          ></lightning-icon>
        </div>
        <h2>No Duplicates Found</h2>
        <p>Great news! There are no duplicate records to show.</p>
        <lightning-button
          label="Run Duplicate Scan"
          icon-name="utility:scan"
          variant="brand"
          onclick={handleRunScan}
          disabled={isRunScanDisabled}
        >
        </lightning-button>
      </div>
    </template>

    <!-- Duplicate Sets List -->
    <template if:true={showDuplicateSets}>
      <section class="duplicates-section">
        <div class="section-header">
          <h2>Duplicate Sets ({totalCount})</h2>
          <lightning-input
            type="search"
            name="search"
            label="Search records"
            placeholder="Search by name, email, or any field..."
            value={searchTerm}
            onchange={handleSearchChange}
            variant="label-hidden"
            class="search-input"
          >
          </lightning-input>
          <template if:true={showSearchResults}>
            <span class="search-results-message">{searchResultsMessage}</span>
          </template>
        </div>

        <div class="duplicate-sets-grid">
          <template for:each={filteredDuplicateSets} for:item="dupSet">
            <div
              key={dupSet.id}
              class="duplicate-set-card"
              onclick={handleSetClick}
              data-id={dupSet.id}
            >
              <div class="set-card-header">
                <div class="set-badge" data-object={dupSet.objectType}>
                  {dupSet.objectType}
                </div>
                <div class="set-count">
                  <span class="count-number">{dupSet.recordCount}</span>
                  <span class="count-label">records</span>
                </div>
              </div>
              <div class="set-card-body">
                <div class="set-name">{dupSet.name}</div>
                <div class="set-rule">
                  <lightning-icon
                    icon-name="utility:rules"
                    size="xx-small"
                  ></lightning-icon>
                  <span>{dupSet.ruleName}</span>
                </div>

                <!-- Preview Section - Compact diff display -->
                <template if:true={dupSet.sampleRecords}>
                  <div class="set-preview">
                    <!-- Record name -->
                    <div class="preview-header">
                      <span class="preview-name">{dupSet.firstRecordName}</span>
                    </div>
                    <template if:true={dupSet.hasAnyFields}>
                      <!-- Identical fields shown once -->
                      <template if:true={dupSet.hasIdenticalFields}>
                        <div class="identical-fields">
                          <template
                            for:each={dupSet.identicalFieldDisplays}
                            for:item="field"
                          >
                            <span key={field.fieldName} class="identical-item">
                              <span class="field-label">{field.label}:</span>
                              <span class="field-value">{field.value}</span>
                            </span>
                          </template>
                        </div>
                      </template>
                      <!-- Differing fields with comparison -->
                      <template if:true={dupSet.hasDifferences}>
                        <div class="diff-summary">
                          <template
                            for:each={dupSet.differingFieldDisplays}
                            for:item="diff"
                          >
                            <span key={diff.fieldName} class="diff-item">
                              <span class="diff-label">{diff.label}:</span>
                              <span class="diff-values">
                                <template if:false={diff.value1Empty}>
                                  <span class="diff-value">{diff.value1}</span>
                                </template>
                                <template if:true={diff.value1Empty}>
                                  <code class="diff-empty">empty</code>
                                </template>
                                <span class="diff-vs">vs</span>
                                <template if:false={diff.value2Empty}>
                                  <span class="diff-value">{diff.value2}</span>
                                </template>
                                <template if:true={diff.value2Empty}>
                                  <code class="diff-empty">empty</code>
                                </template>
                              </span>
                            </span>
                          </template>
                        </div>
                      </template>
                    </template>
                  </div>
                </template>
              </div>
              <div class="set-card-footer">
                <span class="set-date">
                  <lightning-formatted-date-time
                    value={dupSet.createdDate}
                    year="numeric"
                    month="short"
                    day="2-digit"
                  >
                  </lightning-formatted-date-time>
                </span>
                <div class="set-card-actions">
                  <lightning-button-icon
                    icon-name="utility:delete"
                    variant="bare"
                    alternative-text="Delete set"
                    onclick={handleDeleteSet}
                    data-id={dupSet.id}
                    class="delete-btn"
                    title="Delete set"
                  >
                  </lightning-button-icon>
                </div>
              </div>
            </div>
          </template>
        </div>

        <!-- Pagination -->
        <template if:true={showPagination}>
          <div class="pagination">
            <lightning-button
              label="Previous"
              icon-name="utility:chevronleft"
              onclick={handlePrevPage}
              disabled={isPrevDisabled}
              class="page-btn"
            >
            </lightning-button>
            <span class="page-info">Page {currentPage} of {totalPages}</span>
            <lightning-button
              label="Next"
              icon-name="utility:chevronright"
              icon-position="right"
              onclick={handleNextPage}
              disabled={isNextDisabled}
              class="page-btn"
            >
            </lightning-button>
          </div>
        </template>
      </section>
    </template>
  </div>

  <!-- Merge Modal -->
  <template if:true={showMergeModal}>
    <c-duplicate-merge-modal
      duplicate-set-id={mergeSetId}
      onclose={closeMergeModal}
      onmergecomplete={handleMergeComplete}
    >
    </c-duplicate-merge-modal>
  </template>
</template>
